// Prisma schema for RestoBill

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Bill {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // Zahler Info
  payerName     String
  paypalHandle  String // z.B. "maxmustermann" f√ºr paypal.me/maxmustermann

  // Rechnung
  imageUrl       String
  restaurantName String?
  totalAmount    Float?

  // Google Places Integration (f√ºr Review Feature)
  googlePlaceId String? // F√ºr Google Review Deep Links

  // Relations
  items      BillItem[]
  selections Selection[]
  reviews    Review[]

  // Public Link Token
  shareToken String @unique @default(uuid())

  @@index([shareToken])
}

model BillItem {
  id     String @id @default(uuid())
  billId String
  bill   Bill   @relation(fields: [billId], references: [id], onDelete: Cascade)

  name         String // z.B. "Pizza Margherita"
  quantity     Int // z.B. 2
  pricePerUnit Float // z.B. 12.50
  totalPrice   Float // quantity * pricePerUnit

  // Relations
  selections Selection[]

  @@index([billId])
}

enum PaymentMethod {
  PAYPAL
  CASH
}

model Selection {
  id     String @id @default(uuid())
  billId String
  bill   Bill   @relation(fields: [billId], references: [id], onDelete: Cascade)

  friendName String // Eingegebener Name

  // Selected Items - Many-to-Many relationship
  items BillItem[]

  // Quantity multiplier for each item (0.5x, 1x, 2x etc)
  // Stored as JSON: {"itemId": quantity}
  itemQuantities Json? // z.B. {"item-uuid-1": 0.5, "item-uuid-2": 1}

  // Trinkgeld
  tipAmount Float @default(0)

  // Zahlungsmethode
  paymentMethod PaymentMethod @default(PAYPAL)

  // Status
  paid   Boolean   @default(false)
  paidAt DateTime?

  // Review Status (f√ºr Review Feature)
  reviewed Boolean @default(false) // Hat Gast diese Selection reviewed?

  createdAt DateTime @default(now())

  // Relations
  reviews Review[]

  @@index([billId])
}

enum ReviewSentiment {
  SUPER     // üòç
  GUT       // üòä
  OKAY      // üòê
  MAESSIG   // üòï
  SCHLECHT  // üòû
}

model Review {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // Relations
  billId String
  bill   Bill   @relation(fields: [billId], references: [id], onDelete: Cascade)

  selectionId String?
  selection   Selection? @relation(fields: [selectionId], references: [id], onDelete: SetNull)

  // Review Daten
  sentiment ReviewSentiment // Ausgew√§hlte Bewertung

  // Computed: Positiv (SUPER/GUT) oder Negativ (OKAY/MAESSIG/SCHLECHT)
  isPositive Boolean

  // Google Review Tracking
  googleReviewClicked Boolean @default(false) // Hat Nutzer auf "Google Review" geklickt?

  // Internes Feedback (nur bei negativen Reviews)
  internalFeedback String? // Optional: Text-Feedback bei negativen Bewertungen

  @@index([billId])
  @@index([selectionId])
}
