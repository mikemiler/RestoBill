// Prisma schema for RestoBill

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Bill {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // Zahler Info
  payerName     String
  paypalHandle  String // z.B. "maxmustermann" f√ºr paypal.me/maxmustermann

  // Rechnung
  imageUrl       String
  restaurantName String?
  totalAmount    Float?

  // Relations
  items      BillItem[]
  selections Selection[]

  // Public Link Token
  shareToken String @unique @default(uuid())

  @@index([shareToken])
}

model BillItem {
  id     String @id @default(uuid())
  billId String
  bill   Bill   @relation(fields: [billId], references: [id], onDelete: Cascade)

  name         String // z.B. "Pizza Margherita"
  quantity     Int // z.B. 2
  pricePerUnit Float // z.B. 12.50
  totalPrice   Float // quantity * pricePerUnit

  // Relations
  selections Selection[]

  @@index([billId])
}

enum PaymentMethod {
  PAYPAL
  CASH
}

enum SelectionStatus {
  SELECTING // Live tracking - Guest is selecting items (blue badge)
  PAID      // Final payment - Guest has paid (green badge)
}

model Selection {
  id        String  @id @default(uuid())
  billId    String
  bill      Bill    @relation(fields: [billId], references: [id], onDelete: Cascade)

  sessionId  String // Required - unique browser session identifier
  friendName String // Display name

  // Selected Items - Many-to-Many relationship (legacy, not used anymore)
  items BillItem[]

  // Quantity multiplier for each item (0.5x, 1x, 2x etc)
  // Stored as JSON: {"itemId": quantity}
  // Updated in real-time during SELECTING status
  itemQuantities Json? // z.B. {"item-uuid-1": 0.5, "item-uuid-2": 1}

  // Selection Status (NEW)
  status SelectionStatus @default(SELECTING)

  // Trinkgeld (only set when status=PAID)
  tipAmount Float @default(0)

  // Zahlungsmethode (only set when status=PAID)
  paymentMethod PaymentMethod @default(PAYPAL)

  // Payment Status (legacy compatibility)
  paid   Boolean   @default(false)
  paidAt DateTime?

  // Auto-cleanup for abandoned selections
  expiresAt DateTime // Cleanup after 30 days (changed from 30 minutes)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Note: Unique constraint removed to allow multiple payments per guest
  // Partial unique index created via SQL: unique(billId, sessionId) WHERE status='SELECTING'
  // This allows: only one SELECTING per session, but multiple PAID per session
  @@index([billId])
  @@index([sessionId])
  @@index([status])
  @@index([expiresAt])
  @@index([billId, sessionId]) // Composite index for lookups
}
