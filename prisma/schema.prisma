// Prisma schema for RestoBill

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Bill {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // Zahler Info
  payerName     String
  paypalHandle  String // z.B. "maxmustermann" für paypal.me/maxmustermann

  // Rechnung
  imageUrl       String
  restaurantName String?
  totalAmount    Float?

  // Relations
  items            BillItem[]
  selections       Selection[]
  activeSelections ActiveSelection[]

  // Public Link Token
  shareToken String @unique @default(uuid())

  @@index([shareToken])
}

model BillItem {
  id     String @id @default(uuid())
  billId String
  bill   Bill   @relation(fields: [billId], references: [id], onDelete: Cascade)

  name         String // z.B. "Pizza Margherita"
  quantity     Int // z.B. 2
  pricePerUnit Float // z.B. 12.50
  totalPrice   Float // quantity * pricePerUnit

  // Relations
  selections       Selection[]
  activeSelections ActiveSelection[]

  @@index([billId])
}

enum PaymentMethod {
  PAYPAL
  CASH
}

model Selection {
  id        String  @id @default(uuid())
  billId    String
  bill      Bill    @relation(fields: [billId], references: [id], onDelete: Cascade)

  sessionId  String? // Unique browser session (for future /my-bills feature)
  friendName String  // Display name

  // Selected Items - Many-to-Many relationship
  items BillItem[]

  // Quantity multiplier for each item (0.5x, 1x, 2x etc)
  // Stored as JSON: {"itemId": quantity}
  itemQuantities Json? // z.B. {"item-uuid-1": 0.5, "item-uuid-2": 1}

  // Trinkgeld
  tipAmount Float @default(0)

  // Zahlungsmethode
  paymentMethod PaymentMethod @default(PAYPAL)

  // Status
  paid   Boolean   @default(false)
  paidAt DateTime?

  createdAt DateTime @default(now())

  @@index([billId])
  @@index([sessionId])
}

// Live-Anzeige: Temporäre Auswahlen für Realtime-Features
// Session-based tracking: sessionId identifies unique browser sessions
// guestName is used for display only (can have duplicates)
model ActiveSelection {
  id        String   @id @default(uuid())
  billId    String
  itemId    String
  sessionId String   // Unique browser session identifier
  guestName String   // Display name (can have duplicates)
  quantity  Float    // 0, 0.5, 1, 2, etc.
  createdAt DateTime @default(now())
  expiresAt DateTime // Fallback-Cleanup nach z.B. 30 Minuten

  bill Bill     @relation(fields: [billId], references: [id], onDelete: Cascade)
  item BillItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  // Each browser session can only have one entry per item
  @@unique([billId, itemId, sessionId])
  @@index([billId])
  @@index([expiresAt])
  @@index([sessionId])
}
